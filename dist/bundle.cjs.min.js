"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t,e=require("tslib"),i=(t=require("axios"))&&"object"==typeof t&&"default"in t?t.default:t,s=require("ua-parser-js"),n=require("uuid");const a=new class{constructor(){this.onInitEvents=[]}init(t){return e.__awaiter(this,void 0,void 0,(function*(){const e=i.create({baseURL:"https://api.loopmetrics.jp",headers:{"x-api-key":t.apiKey}});if(this.httpClient=e,this.config=Object.assign(Object.assign({},t),{session:{}}),void 0!==t.user&&void 0!==t.user.distinctId||this.getDistinctUserIdFromLocalStorage(),t.tenant){const e=yield this.updateTenantAsync(t.tenant);this.internalTenantId=e.internalTenantId}if(t.user){const e=yield this.updateUserAsync(t.user);this.internalUserId=e.internalUserId,this.config.session.sessionId=e.sessionId,this.config.session.updatedAt=e.sessionUpdatedAt}this.onInitEvents.forEach(t=>{this.track(t.eventName,t.eventProperties,t.callback)})}))}track(t,i,s){var n,a;return e.__awaiter(this,void 0,void 0,(function*(){if(this.internalUserId)try{const e=yield this.httpClient.post("/v1/track/events",this.appendProperties({internalTenantId:this.internalTenantId,internalUserId:this.internalUserId,tenantId:null===(n=this.config.tenant)||void 0===n?void 0:n.distinctId,userId:null===(a=this.config.user)||void 0===a?void 0:a.distinctId,name:t,session:this.config.session},i));this.config.session.sessionId=e.data.session.id,this.config.session.updatedAt=e.data.session.updatedAt,s&&s()}catch(t){console.error(t)}else{const e=i?" with properties {JSON.stringify(eventProperties)}":"";console.warn(`Loopmetrics sdk has not yet finished initializing. Event ${t}${e} was not sent.`)}}))}trackOnInit(t,i,s){return e.__awaiter(this,void 0,void 0,(function*(){this.onInitEvents.push({eventName:t,eventProperties:i,callback:s})}))}updateTenant(t){const e=Object.assign(Object.assign({},this.config.tenant),t);this.httpClient.post("/v1/track/tenants",this.appendProperties({id:e.distinctId,companyName:e.companyName},e.properties))}updateTenantAsync(t){return e.__awaiter(this,void 0,void 0,(function*(){const e=Object.assign(Object.assign({},this.config.tenant),t);return(yield this.httpClient.post("/v1/track/tenants",this.appendProperties({id:e.distinctId,companyName:e.companyName},e.properties))).data}))}updateUser(t){var e;const i=Object.assign(Object.assign({},this.config.user),t);this.httpClient.post("/v1/track/users",this.appendProperties({internalTenantId:this.internalTenantId,id:i.distinctId,tenantId:null===(e=this.config.tenant)||void 0===e?void 0:e.distinctId,firstName:i.firstName,lastName:i.lastName,email:i.email},i.properties))}updateUserAsync(t){var i;return e.__awaiter(this,void 0,void 0,(function*(){const e=yield this.getGeolocation(),n=new s.UAParser,a={browser:n.getBrowser().name,browserVersion:n.getBrowser().major,os:n.getOS().name,osVersion:n.getOS().version,country:null==e?void 0:e.country,region:null==e?void 0:e.region},o=Object.assign(Object.assign({},this.config.user),t);return(yield this.httpClient.post("/v1/track/users",this.appendProperties({internalTenantId:this.internalTenantId,id:o.distinctId,tenantId:null===(i=this.config.tenant)||void 0===i?void 0:i.distinctId,firstName:o.firstName,lastName:o.lastName,email:o.email,session:a},o.properties))).data}))}getGeolocation(){return e.__awaiter(this,void 0,void 0,(function*(){const t=yield i.get("http://ip-api.com/json?fields=status,message,country,regionName&lang=ja");return"fail"===t.data.status?yield new Promise(t=>{setTimeout(()=>e.__awaiter(this,void 0,void 0,(function*(){const e=yield i.get("http://ip-api.com/json?fields=status,message,country,regionName&lang=ja");"fail"!==e.data.status?t({country:e.data.country,region:e.data.regionName}):t(void 0)})),3e3)}):{country:t.data.country,region:t.data.regionName}}))}getDistinctUserIdFromLocalStorage(){const t=localStorage.getItem("lm_s");if(null!==t)this.config.user=Object.assign(Object.assign({},this.config.user),{distinctId:t});else{localStorage.setItem("lm_s",n.v4());const t=localStorage.getItem("lm_s");this.config.user=Object.assign(Object.assign({},this.config.user),{distinctId:t})}}appendProperties(t,e){return void 0===e?t:Object.assign(Object.assign({},t),{properties:e})}};exports.default=a,exports.loopmetrics=a;
